<script id="span-row-template" type="template/underscore" charset="utf-8">
<div id="<%= span_id %>">
  <div class="handle">
    <div class="service-name">
      <span class="expander">+</span>
      <%= service_name %>
    </div>
  </div>
</div>
</script>

<script type="text/javascript">
  var spanParentObj = {};

  /*
     These spans represent span_id as key,
     whose value equals parent_id of the span

     In case parent_id is None, it indicates the
     parent most span
  */
  {% for key, value in spanParentDict.iteritems() %}
    spanParentObj['{{ key }}'] = '{{ value }}'
  {% endfor %}

  /*
     Fill in annotations structure.

     Annotation structure should contain all information we require
     for building simple annotations inside trace view
  */

  var annotations = [];

  {% for row in annotations %}
    annotations.push({
      'span_id': "{{ row['span_id'] }}",
      'span_name': "{{ row['span_name'] }}",
      'service_name': "{{ row['service_name'] }}",
      'value': "{{ row['value'] }}",
      'ipv4': "{{ row['ipv4'] }}",
      'port': "{{ row['port'] }}",
      'a_timestamp': "{{ row['a_timestamp'] }}"
    });
  {% endfor %}


  // will be filled on page laod
  var spanStructure;

  // Custom sort annotations structure by timestamp value ASC
  var sortedAnnotations;

  window.addEventListener('load', traceLoaded);

  function traceLoaded() {
    // template for span row
    var spanRowTemplate;


    // fill span structure with span information
    fillSpanStructure();

    // #trace-container DOM node
    var $traceContainer = $('#trace-container');

    // fetching and creating template for span row
    spanRowTemplate = _.template($('#span-row-template').html());

    // sorted annotations by timestamp ASC
    sortedAnnotations = _.sortBy(annotations, 'a_timestamp');

    // services used to display trace information
    var services;

    spans = createSpanTree();

    printSpanTree(spans);
  }


  function printSpanTree(spans) {

    var i, j;
    var obj, str, childrenLength;

    str = '';

    for (var key in spans) {
      obj = spans[key];

      for (i = 0; i < obj.depth; i++) {
        str += ' ';
      }

      console.log(str, obj.span_name);

      childrenLength = obj.children.length;

      for (j = 0; j < childrenLength; j++) {
        printSpanTree( obj['children'] );
      }
    }
  }

  function fillSpanStructure() {
    var spanObjects = {};

    for (var key in spanParentObj) {
      spanObjects[key] = getSpanInformation(key);
    }

    spanStructure = spanObjects;
  }

  function getSpanInformation(key)
  {
    var i, len, obj;

    obj = {};
    len = annotations.length;

    for (i = 0; i < len; i++) {
      if (annotations[i]['span_id'] == key) {
        obj = {
          'span_id': key,
          'span_name': annotations[i]['span_name'],
          'parent_id': spanParentObj[key]
        };

        break;
      }
    }

    return obj;
  }

  function createSpanTree() {

    var rootSpanId;

    rootSpanId = '';

    for (var key in spanParentObj) {
      if (spanParentObj[key] == 'None') {
        rootSpanId = key;
        break;
      }
    }

    var tree = {}, spanInfo;

    spanInfo = spanStructure[rootSpanId];

    // fill structure for root tree node
    tree[rootSpanId] = {
      'id': rootSpanId,
      'parent_id': 'None',
      'span_name': spanInfo['span_name'],
      'services': getSpanServices(rootSpanId),
      'depth': 0,
      'children': getChildNodes(rootSpanId, 1)
    };

    console.log('tree', tree);

    return tree;
  }

  function getChildNodes(spanId, depth) {
    var children;
    var childSpanIds;

    children = [];
    childSpanIds = getChildSpanIds( spanId );

    var i, len, childSpanId, spanInfo;

    len = childSpanIds.length;

    for (var i = 0; i < len; i++) {
      childSpanId = childSpanIds[i];
      spanInfo = spanStructure[childSpanId];

      children.push({
        'id': childSpanId,
        'parent_id': spanId,
        'span_name': spanInfo['span_name'],
        'services': getSpanServices(spanId),
        'depth': depth,
        'children': getChildNodes(childSpanId, depth + 1)
      });
    }

    return children;
  }

  function getSpanServices(spanId) {
    var i, len, annotation, services;

    len = annotations.length;
    services = [];

    for (i = 0; i < len; i++) {
      annotation = annotations[i];

      if (annotation['span_id'] == spanId) {
        services.push({
          'service_name': annotation['service_name'],
          'value': annotation['value'],
          'ipv4': annotation['ipv4'],
          'port': annotation['port'],
          'a_timestamp': annotation['a_timestamp']
        });
      }
    }

    return services;
  }

  function getChildSpanIds(parentSpanId) {
    var spanIds;

    spanIds = [];

    for (var key in spanParentObj) {
      if (spanParentObj[key] == parentSpanId) {
        spanIds.push( key );
      }
    }

    return spanIds;
  }

</script>
